name: CI Multi-Env Pipeline

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write        # å»ºç«‹ release / ä¿®æ”¹å…§å®¹
  issues: write          # å¤±æ•—è‡ªå‹•é–‹ Issueï¼ˆO ç´šï¼‰
  actions: read

env:
  # å¯åœ¨ repo â†’ Settings â†’ Actions â†’ Variables è¦†è“‹
  BUILD_TAG_PREFIX: dev
  RELEASE_NOTE: "Automated release"
  COV_MIN: "75"          # O ç´šï¼šè¦†è“‹ç‡é–€æª»ï¼ˆ%ï¼‰

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.1.29"

      - name: Build (bun i + ncc)
        run: npm run build

      - name: Package build as zip
        run: zip -r build.zip dist/ package.json action.yml licenses.txt || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: build.zip

  # ------------------ E + Oï¼šUnit æ¸¬è©¦ï¼ˆçŸ©é™£ï¼‰ ------------------
  test-unit:
    name: Test - Unit (matrix)
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [18, 20, 22]   # O ç´šï¼šå¤š Node ç‰ˆæœ¬
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Unzip artifact
        run: unzip -o build.zip -d ./build_artifact

      - name: Run Unit Tests (TEST_ENV=staging)
        env:
          TEST_ENV: staging         # E ç´šï¼šåƒæ•¸åŒ–ç’°å¢ƒè®Šæ•¸
        run: npm run test:unit

  # ------------------ Eï¼šIntegration æ¸¬è©¦ ------------------
  test-integration:
    name: Test - Integration
    needs: test-unit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Unzip artifact
        run: unzip -o build.zip -d ./build_artifact
      - name: Run Integration Tests (TEST_ENV=staging)
        env:
          TEST_ENV: staging
        run: npm run test:integration

  # ------------------ Oï¼šç”¢ç”Ÿè¦†è“‹ç‡ + é–€æª»ç®¡åˆ¶ ------------------
  coverage:
    name: Coverage & Gate
    needs: test-integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Generate Coverage (mock or real)
        run: npm run test:coverage
      - name: Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/
      - name: Enforce Coverage Threshold
        id: cov
        run: |
          val=$(grep -oE 'coverage=[0-9]+' coverage/summary.txt | cut -d= -f2)
          echo "coverage=$val"
          echo "coverage=$val" >> $GITHUB_OUTPUT
          if [ "$val" -lt "${COV_MIN}" ]; then
            echo "Coverage $val% is below threshold ${COV_MIN}%."
            exit 1
          fi

  # ------------------ Eï¼šéƒ¨ç½²åˆ° Stagingï¼ˆéœ€æ¸¬è©¦å…¨é & è¦†è“‹ç‡éé—œï¼‰ ------------------
  deploy-staging:
    name: Deploy - Staging
    needs: [test-integration, coverage]
    if: needs.coverage.outputs.ok == 'true'   # è¦†è“‹ç‡ä¸è¶³ â†’ ç›´æ¥ skipped
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Release to Staging
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "staging-${{ github.run_number }}"
          name: "Staging Build #${{ github.run_number }}"
          body: "Staging release after passing tests & coverage >= ${{ env.COV_MIN }}%"
          files: |
            build.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------ Eï¼šéƒ¨ç½²åˆ° Productionï¼ˆéœ€ reviewers æ‰‹å‹•æ ¸å‡†ï¼‰ ------------------
  deploy-production:
    name: Deploy - Production
    needs: deploy-staging
    if: needs.coverage.outputs.ok == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production       
      url: https://example.com 
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Release to Production
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "prod-${{ github.run_number }}"
          name: "Production Build #${{ github.run_number }}"
          body: "Production release after manual approval and successful staging"
          files: |
            build.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------ Oï¼šå¤±æ•—æ™‚è‡ªå‹•é–‹ Issueï¼ˆé›†ä¸­è¨˜éŒ„ï¼‰ ------------------
  on-failure-open-issue:
    name: Failure Reporter
    needs:
      - build
      - test-unit
      - test-integration
      - coverage
      - deploy-staging
      - deploy-production
    if: failure()   # åªåœ¨ä»»ä¸€éœ€è¦çš„ job å¤±æ•—æ™‚è§¸ç™¼
    runs-on: ubuntu-latest
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const failedJobs = [
              'build','test-unit','test-integration','coverage','deploy-staging','deploy-production'
            ];
            const title = `ğŸš¨ CI Failure in run #${context.runNumber}`;
            const body = `One or more jobs failed in workflow **${context.workflow}**.
            - Commit: ${context.sha}
            - Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            - Possibly failed jobs: ${failedJobs.join(', ')}

            Please check the logs and address the issue.`;
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body
              });
            } catch (e) {
              core.warning('Issue creation failed: ' + e.message);
            }
